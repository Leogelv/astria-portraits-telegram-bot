# Логика работы Telegram-бота для Astria AI

## 1. Общая архитектура

Telegram-бот для Astria AI построен на основе вебхуков и интегрирован с основным приложением. Вместо использования отдельного Python-бота, мы используем Next.js API-роуты для обработки вебхуков от Telegram API и взаимодействия с Supabase и Astria API.

### 1.1. Компоненты системы

1. **Telegram API** - внешний API для взаимодействия с Telegram
2. **Webhook Endpoint** - `/api/bot/webhook` - принимает обновления от Telegram
3. **Supabase** - хранение данных пользователей, моделей и промптов
4. **Astria API** - API для обучения моделей и генерации изображений
5. **API Endpoints** - `/api/bot/train-model` и `/api/bot/generate` - эндпоинты для взаимодействия с Astria API

### 1.2. Поток данных

1. Пользователь отправляет сообщение боту в Telegram
2. Telegram отправляет обновление на наш вебхук-эндпоинт
3. Вебхук-эндпоинт обрабатывает сообщение и взаимодействует с Supabase и API
4. Результаты отправляются обратно пользователю через Telegram API

## 2. Структура базы данных

### 2.1. Таблица `telegram_users`

Хранит информацию о пользователях Telegram:

```sql
CREATE TABLE IF NOT EXISTS telegram_users (
  id SERIAL PRIMARY KEY,
  telegram_id BIGINT UNIQUE NOT NULL,
  username TEXT,
  first_name TEXT,
  last_name TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  last_active TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  status TEXT DEFAULT 'active',
  credits INTEGER DEFAULT 0
);
```

### 2.2. Таблица `telegram_models`

Хранит информацию о моделях пользователей:

```sql
CREATE TABLE IF NOT EXISTS telegram_models (
  id SERIAL PRIMARY KEY,
  telegram_user_id BIGINT REFERENCES telegram_users(telegram_id),
  model_id INTEGER NOT NULL, -- ID модели из основной таблицы models
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  status TEXT DEFAULT 'training'
);
```

### 2.3. Таблица `telegram_prompts`

Хранит информацию о промптах пользователей:

```sql
CREATE TABLE IF NOT EXISTS telegram_prompts (
  id SERIAL PRIMARY KEY,
  telegram_user_id BIGINT REFERENCES telegram_users(telegram_id),
  model_id INTEGER NOT NULL,
  prompt TEXT NOT NULL,
  prompt_id TEXT, -- ID промпта из Astria API
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  status TEXT DEFAULT 'processing',
  images JSONB -- массив URL-адресов сгенерированных изображений
);
```

## 3. Основные функции бота

### 3.1. Регистрация пользователя

При первом взаимодействии с ботом пользователь автоматически регистрируется в системе:

1. Проверяем наличие пользователя в базе данных по `telegram_id`
2. Если пользователь не найден, создаем новую запись в таблице `telegram_users`
3. Даем новому пользователю 3 кредита для начала работы

### 3.2. Обработка команд

Бот поддерживает следующие команды:

- `/start` - начало работы с ботом, приветствие
- `/help` - справка по использованию бота
- `/train` - начать обучение новой модели
- `/generate` - сгенерировать изображения с существующей моделью
- `/models` - список моделей пользователя
- `/credits` - информация о кредитах пользователя

### 3.3. Обучение модели

Процесс обучения модели:

1. Пользователь отправляет команду `/train`
2. Бот просит загрузить 4 фотографии
3. Пользователь загружает фотографии
4. Бот просит ввести имя модели
5. Бот отправляет запрос на обучение модели через API
6. Бот создает запись в таблице `telegram_models`
7. Бот уведомляет пользователя о начале обучения
8. После завершения обучения бот уведомляет пользователя

### 3.4. Генерация изображений

Процесс генерации изображений:

1. Пользователь отправляет команду `/generate`
2. Бот показывает список доступных моделей
3. Пользователь выбирает модель
4. Бот просит ввести промпт
5. Бот отправляет запрос на генерацию изображений через API
6. Бот создает запись в таблице `telegram_prompts`
7. Бот уведомляет пользователя о начале генерации
8. После завершения генерации бот отправляет изображения пользователю

## 4. Управление состоянием

Для управления состоянием пользователя используется подход на основе контекста сообщений:

1. Каждое сообщение от пользователя обрабатывается в контексте предыдущих сообщений
2. Состояние пользователя хранится в базе данных
3. Для каждого пользователя отслеживается текущий этап взаимодействия (загрузка фотографий, ввод имени модели и т.д.)

## 5. Обработка ошибок

Система обработки ошибок включает:

1. Логирование всех ошибок в консоль
2. Отправку понятных сообщений об ошибках пользователю
3. Обработку таймаутов и повторных попыток при взаимодействии с API
4. Уведомление администратора о критических ошибках

## 6. Безопасность

Меры безопасности:

1. Проверка авторизации пользователя
2. Ограничение количества запросов
3. Валидация входных данных
4. Защита от спама и флуда

## 7. Интеграция с основным приложением

Бот интегрирован с основным приложением:

1. Использует те же API-эндпоинты для обучения моделей и генерации изображений
2. Имеет доступ к той же базе данных
3. Использует те же переменные окружения

## 8. Мониторинг и логирование

Система мониторинга и логирования:

1. Логирование всех действий пользователя
2. Логирование всех запросов к API
3. Логирование всех ошибок
4. Отслеживание использования кредитов

## 9. Расширение функциональности

Планы по расширению функциональности:

1. Добавление поддержки платежей
2. Добавление поддержки различных стилей генерации
3. Добавление поддержки различных типов моделей
4. Добавление поддержки различных языков 